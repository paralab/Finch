#!/usr/bin/env python

import os
import sys

sys.path.append(os.environ['TALYFEM_DIR'] + '/python_scripts')

from test_common import run_tests
from test_common import DEFAULT_PROGRAM_PATH
from test_common import DEFAULT_PROGRAM_ARGS
from test_common import have_mumps
from test_common import all_tests_passed

# note: these t* numberings are from the old shell script tests.
# the actual test IDs are zero-indexed, so test_id == 0 is the test marked t1, etc.
tests = [
{
# t1
"__NUM_PROCESSORS": 1,
"__DESCR": "1D,Box,1N,noDD x:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 1,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t2
"__NUM_PROCESSORS": 1,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 2,
"ifBoxGrid": True,
"ifTriElem": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t3
"__NUM_PROCESSORS": 1,
"__DESCR": "3D,Box,1N,noDD x,y,z:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"Lz": 1,
"Nelemz": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t4
"__NUM_PROCESSORS": 1,
"__DESCR": "1D,Box,2N,noDD x:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 1,
"ifBoxGrid": True,
"basisFunction": "quadratic",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t5
"__NUM_PROCESSORS": 1,
"__DESCR": "2D,Box,2N,noDD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "quadratic",
"ifDD": False,
"Lx": 1,
"Nelemx": 10,
"Ly": 1,
"Nelemy": 10,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t6
"__NUM_PROCESSORS": 1,
"__DESCR": "3D,Box,2N,noDD x,y,z:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "quadratic",
"ifDD": False,
"Lx": 1,
"Nelemx": 10,
"Ly": 1,
"Nelemy": 10,
"Lz": 1,
"Nelemz": 10,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t7
"__NUM_PROCESSORS": 1,
"__DESCR": "1D,Box,3N,noDD x:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 1,
"ifBoxGrid": True,
"basisFunction": "cubic",
"ifDD": False,
"Lx": 1,
"Nelemx": 21,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t8
"__NUM_PROCESSORS": 1,
"__DESCR": "2D,Box,3N,noDD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "cubic",
"ifDD": False,
"Lx": 1,
"Nelemx": 21,
"Ly": 1,
"Nelemy": 21,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t9
"__NUM_PROCESSORS": 1,
"__DESCR": "3D,Box,3N,noDD x,y,z:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "cubic",
"ifDD": False,
"Lx": 1,
"Nelemx": 21,
"Ly": 1,
"Nelemy": 21,
"Lz": 1,
"Nelemz": 21,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t10
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(all)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t11
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"outputVarList": "[u,u_a]",
}, 
{
# t12
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y,z:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"varListOutput": "[u,u_a]",
}, 
{
# t13
 "__NUM_PROCESSORS": 2,
"__DESCR": "3D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(all)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"Lz": 1,
"Nelemz": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t14
"__NUM_PROCESSORS": 2,
"__DESCR": "3D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(u,u_a)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"Lz": 1,
"Nelemz": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"varListOutput": "[u,u_a]",
}, 
{
# t15
"__NUM_PROCESSORS": 2,
"__DESCR": "3D,Box,1N,noDD x,y,z:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(default) Output(u,u_a)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"Lz": 1,
"Nelemz": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"varListOutput": "[u,u_a]",
}, 
{
# t16
"__NUM_PROCESSORS": 2,
"__PROGRAM_ARGS": ["-ksp_type", "preonly", "-pc_type", "lu", "-pc_factor_mat_solver_package", "mumps"],
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(mumps) Output(all)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
}, 
{
# t17
"__NUM_PROCESSORS": 2,
"__PROGRAM_ARGS": ["-ksp_type", "preonly", "-pc_type", "lu", "-pc_factor_mat_solver_package", "mumps"],
"__DESCR": "3D,Box,1N,DD x,y:L=1(Nel=20),	IC(1), dt(0.001), nOfTS(10) Petsc(mump) Output(u,u_a)",
"nsd": 3,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"Lz": 1,
"Nelemz": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"varListOutput": "[u,u_a]",
}, 
{
# t18
"__COPY_FILES": "t18_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(u, u_a - available: u, u_pre, u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t18_data_init_2D.plt",
"varListInput": "[u,u_a]",}, 
{
# t19
"__COPY_FILES": "t19_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(All-but only u,u_a available)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t19_data_init_2D.plt",
}, 
{
# t20
"__COPY_FILES": "t20_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(u - available u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t20_data_init_2D.plt",
"varListInput ": "[u]",
}, 
{
# t21
"__COPY_FILES": "t21_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u,u_a) Input(u available u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t21_data_init_2D.plt",
"varListInput ": "[u]",
"varListOutput ": "[u,u_a]",
}, 
{
# t22
"__COPY_FILES": "t22_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u) Input(u available: u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t22_data_init_2D.plt",
"varListInput ": "[u]",
"varListOutput ": "[u]",
}, 
{
# t23
"__COPY_FILES": "t23_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,noDD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u) Input(u,u_a available: u), SHOULD FAIL",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": False,
"shouldFail": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t23_data_init_2D.plt",
"varListInput ": "[u,u_analytical]",
"varListOutput ": "[u]",
}, 
{
# t24
"__COPY_FILES": "t24_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(All)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t24_data_init_2D.plt",
}, 
{
# t25
"__COPY_FILES": "t25_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(All-but only u,u_a available)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t25_data_init_2D.plt",
}, 
{
# t26
"__COPY_FILES": "t26_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(all) Input(u - available u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t26_data_init_2D.plt",
"varListInput ": "[u]",
}, 
{
# t27
"__COPY_FILES": "t27_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u,u_a) Input(u available u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t27_data_init_2D.plt",
"varListInput ": "[u]",
"varListOutput ": "[u,u_a]",
}, 
{
# t28
"__COPY_FILES": "t28_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u) Input(u available: u,u_a)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"inputFilenameGridField": "t28_data_init_2D.plt",
"varListInput ": "[u]",
"varListOutput ": "[u]",
}, 
{
# t29
"__COPY_FILES": "t29_data_init_2D.plt",
"__NUM_PROCESSORS": 2,
"__DESCR": "2D,Box,1N,DD x,y:L=1(Nel=20),	IC(0-data_init_2D.plt) Output(u) Input(u,u_a available: u), SHOULD FAIL",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "linear",
"ifDD": True,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 0,
"dt": 0.001,
"nOfTS": 10,
"shouldFail": True,
"inputFilenameGridField": "t29_data_init_2D.plt",
"varListInput ": "[u,u_analytical]",
"varListOutput ": "[u]",
},
{
# t30 - testing elemental assembly
"__NUM_PROCESSORS": 1,
"__DESCR": "2D,Box,2N,noDD x,y:L=1(Nel=20),elemental	IC(1), dt(0.001), nOfTS(10) Petsc(default)",
"nsd": 2,
"ifBoxGrid": True,
"basisFunction": "quadratic",
"ifDD": False,
"Lx": 1,
"Nelemx": 20,
"Ly": 1,
"Nelemy": 20,
"typeOfIC": 1,
"dt": 0.001,
"nOfTS": 10,
"use_elemental_assembly": 1,
},
]

PROGRAM_PATH = DEFAULT_PROGRAM_PATH
EXECUTABLE_PATH = os.environ['EXECUTABLE_PATH']
PROGRAM_ARGS = DEFAULT_PROGRAM_ARGS + ["-n", "__NUM_PROCESSORS", EXECUTABLE_PATH]

if not have_mumps():
  for test in tests:
    if "__PROGRAM_ARGS" in test and "mumps" in test["__PROGRAM_ARGS"]:
      test["__SKIP"] = "MUMPS not installed"

results = run_tests(tests, PROGRAM_PATH, PROGRAM_ARGS)
sys.exit(0 if all_tests_passed(results) else 1)

